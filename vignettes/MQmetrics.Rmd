---
title: "MQmetrics"
author: 'Alvaro Sanchez-Villalba'
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MQmetrics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


\pagebreak

# Overview

The package MQmetrics (MaxQuant metrics) provides a workflow to analyze the quality and reproducibility of your proteomics mass spectrometry analysis from MaxQuant. It requires several files generated from MaxQuant, and produces a pdf report. 
It includes several visualization tools to check numerous parameters regarding the quality of the runs.
It also includes two function to visualize the [iRT peptides from Biognosys](https://biognosys.com/product/irt-kit/) in case they were spiked in the samples.

# Workflow

## Data Input

You can install the development version from [GitHub](https://github.com/BioAlvaro/) with:

``` {r install, eval = FALSE}
# install.packages("devtools")

devtools::install_github("BioAlvaro/MQmetrics")
```

# Data Input

After your MaxQuant run has finished, a folder named **combined** has been created. This folder should have at least two other folders within: 

     ../combined/txt/ Containing all the tables.txt
     ../combined/proc/ Containing #runningTimes.txt

You just need the path to the **combined** folder and you will be able to start using MQmetrics.

```{r MQPathCombined}
MQPathCombined <- '/home/alvaro/Documents/MaxQuant/example5/combined/'
```


## Generate a report

First you need to load the library.

```{r report, message=FALSE}
library(MQmetrics)
```

Then you just need to use the **generateReport()** function. This function has parameters to control each of the function that it aggregates. You can read more about those parameters by using:

```{r report_question_mark, eval=FALSE}
?generateReport
```

Though, the most important parameters are the following:

```{r parameters, eval=FALSE}
generateReport(MQPathCombined = , # directory to the combined folder
               output_dir = , # directory to store the resulting pdf
               long_names = , # If your samples have long names set it to TRUE
               sep_names = , # Indicate the separator of those long names
               UniprotID = , # Introduce the UniprotID of a protein of interest
               intensity_type = ,) # Intensity or LFQ

# The only mandatory parameter is MQPathCombined, the rest are optional.
```


Is as simple as this to use MQmetrics:
```{r example,eval=FALSE}
MQPathCombined <- '/home/alvaro/Documents/MaxQuant/example5/combined/'
generateReport(MMQPathCombined)
```

## Visualization plots

If you are only interested in a few plots from the **generateReport()** function, you can do it.
You only need to have access to each file independently.

### Load the data

```{r, message=FALSE, warning=FALSE}

# To create the vignettes and examples I use data that is in the package itself:
MQPathCombined <- system.file('extdata/combined/', package = 'MQmetrics')

# But in a real world scenario, your data will be in a folder in your computer:

# MQPathCombined <- '/home/user/MaxQuant_outputs/example1/combined'


# ReadDataFromDir will read the tables needed for creating the outputs.
files <- ReadDataFromDir(MQPathCombined, remove_contaminants = TRUE) 

# files can be extracted like this:

summary <- files[["summary.txt"]]
evidence <- files[["evidence.txt"]]
msScans <- files[['msScans.txt']]
peptides <- files[["peptides.txt"]]
msmsScans <- files[["msmsScans.txt"]]
proteinGroups <- files[["proteinGroups.txt"]]
modificationSpecificPeptides <- files[["modificationSpecificPeptides.txt"]]
parameters <- files[["parameters.txt"]]
runningTimes <-  files[["#runningTimes.txt"]]
```


### Experiment Information

```{r ExperimentDuration, comment= NA}
ExperimentInformation(MQPathCombined,runningTimes, parameters) 
```
### Plots 

```{r PlotProteins}
PlotProteinsIdentified(proteinGroups,  long_names = TRUE, sep_names = '_')
```

```{r PeptidesIdentified, warning=FALSE , fig.height=5, fig.width=7.2}
PlotPeptidesIdentified(summary, long_names = TRUE, sep_names = '_')

#Show in the tables a a percentage.
```

```{r PlotMSMS, fig.height=5, fig.width=7.2}
PlotMsMs(summary,long_names = TRUE, sep_names = '_')

#Show 40% line
```

```{r PlotPeaks, fig.height=5, fig.width=7.2}
PlotPeaks(summary, long_names = TRUE, sep_names = '_')
```

```{r isotope, fig.height=5, fig.width=7.2}
PlotIsotopePattern(summary,long_names = TRUE, sep_names = '_')
```

```{r Charg, warning=FALSE, message=FALSE, fig.height=6, fig.width=7.2}
PlotCharge(evidence)
```

```{r missed_cleavages,fig.height=10}
PlotProteaseSpecificity(peptides)

# show in tabular format. (table.) 
```

```{r PlotHydrophobicity, warning= FALSE, message= FALSE}
PlotHydrophobicity(peptides, palette = 'Set2', show_median =  TRUE, binwidth = 0.1)

#make the line thicker
```

```{r AndromedaScore, message = FALSE, warning = FALSE}
PlotAndromedaScore(peptides)
```

```{r IdentificationType,message = FALSE, warning = FALSE, fig.height=5, fig.width=7.2}
if(parameters$Value[27] == "True"){
  PlotIdentificationType(peptides, 
                         proteinGroups,
                         palette = 'Set2',
                         long_names = TRUE, 
                         sep_names = '_')  
} else{
  cat('Match Between Runs was not used during the MaxQuant analysis.
No Identification Type to show.')
}
```

```{r PlotIntensity, warning = FALSE, fig.height=5, fig.width=7.2}
PlotIntensity(proteinGroups, split_violin_intensity = TRUE, intensity_type = 'LFQ', 
              log_base = 2, long_names = TRUE, sep_names = '_')



### when too many samples more than 20, the split_violin function did not work.


```

```{r PlotPCA, warning = FALSE, fig.height=5, fig.width=7.2}
PlotPCA(proteinGroups, intensity_type = 'Intensity', palette = 'Set2')
```

```{r DynamicRange, fig.height=5, fig.width=7.2}
PlotCombinedDynamicRange(proteinGroups, show_shade = TRUE, percent_proteins = 0.79)
```

```{r DynamicRangeAll, fig.height=10, fig.width=7.2}
PlotAllDynamicRange(proteinGroups,show_shade = TRUE, percent_proteins = 0.90)
```

```{r protein_coverage_all}
PlotProteinCoverageAll(proteinGroups)

#Put in a table at the end of tables.

```

```{r protein_degradation}
PlotProteinCoverage(peptides,proteinGroups, UniprotID = "Q99714", log_base = 2, segment_width = 1)
```

```{r irt_peps1, warning = FALSE, message= FALSE, fig.height=8, fig.width=9.2}
PlotiRT(evidence)
```

```{r irt_peps2, warning = FALSE, message= FALSE, fig.height=8, fig.width=9.2}
PlotiRTScore(evidence)
```

```{r TotalIonCurrent, fig.height=10, fig.width=7.2}
PlotTotalIonCurrent(msmsScans, show_max_value = TRUE)

```

```{r PlotAcquisition, fig.height= 10, warning=FALSE, message=FALSE}
PlotAcquisitionCycle(msScans)
```

```{r PTM, fig.height=8, fig.width=7.2}
PlotPTM(modificationSpecificPeptides, peptides_modified = 1, plot_unmodified_peptides = FALSE, palette = 'Set2')
```
